<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Memory Hanoi">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <title>Memory Tower of Hanoi</title>
    <style>
        /* Fix for iOS 100vh issue */
        html {
            height: -webkit-fill-available;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left));
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 32px;
            margin-bottom: 20px;
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (min-width: 768px) {
            body { padding: max(40px, env(safe-area-inset-top)) max(40px, env(safe-area-inset-right)) max(40px, env(safe-area-inset-bottom)) max(40px, env(safe-area-inset-left)); }
            .card { padding: 48px; margin-bottom: 32px; }
        }
        
        /* iPad Portrait and Landscape optimizations */
        @media (min-width: 768px) and (max-width: 1024px) {
            .towers-container {
                gap: 40px;
            }
            .tower-body {
                width: 150px;
                height: 260px;
            }
            .disc.d1 { width: 40px; }
            .disc.d2 { width: 60px; }
            .disc.d3 { width: 80px; }
            .disc.d4 { width: 100px; }
            .disc.d5 { width: 120px; }
            .disc.d6 { width: 140px; }
            .disc.d7 { width: 140px; }
            .disc.d8 { width: 140px; }
        }
        
        h1 {
            font-size: 2rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        @media (min-width: 768px) {
            h1 { font-size: 3rem; margin-bottom: 32px; }
        }
        
        h2 {
            font-size: 1.25rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            color: #1f2937;
        }
        
        @media (min-width: 768px) {
            h2 { font-size: 1.75rem; margin-bottom: 28px; }
        }
        
        .hidden { display: none; }
        
        /* Setup */
        .label {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: #374151;
            text-align: center;
            letter-spacing: 0.5px;
        }
        
        @media (min-width: 768px) {
            .label { font-size: 1.125rem; margin-bottom: 20px; }
        }
        
        .disc-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 32px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        @media (min-width: 768px) {
            .disc-grid {
                grid-template-columns: repeat(6, 1fr);
                gap: 16px;
            }
        }
        
        .disc-btn {
            padding: 20px;
            font-size: 1.5rem;
            font-weight: 700;
            border: 2px solid transparent;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #6b7280;
            touch-action: manipulation;
            min-height: 70px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .disc-btn:active {
            transform: scale(0.95);
        }
        
        .disc-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transform: scale(1.05);
        }
        
        .diff-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
            max-width: 600px;
            margin: 0 auto 32px;
        }
        
        @media (min-width: 768px) {
            .diff-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }
        }
        
        .diff-btn {
            padding: 24px 20px;
            font-weight: 700;
            border: 2px solid transparent;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            color: #6b7280;
            touch-action: manipulation;
            min-height: 100px;
            -webkit-tap-highlight-color: transparent;
        }
        
        .diff-btn > div:first-child {
            font-size: 1.25rem;
            margin-bottom: 8px;
        }
        
        .diff-btn > div:last-child {
            font-size: 0.875rem;
            opacity: 0.8;
        }
        
        @media (min-width: 768px) {
            .diff-btn { padding: 28px 24px; }
            .diff-btn > div:first-child { font-size: 1.5rem; }
            .diff-btn > div:last-child { font-size: 0.95rem; }
        }
        
        .diff-btn:active { transform: scale(0.98); }
        
        .diff-btn.easy.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
        }
        
        .diff-btn.medium.active {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(245, 158, 11, 0.4);
        }
        
        .diff-btn.hard.active {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(249, 115, 22, 0.4);
        }
        
        .diff-btn.expert.active {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4);
        }
        
        .start-btn {
            display: block;
            margin: 0 auto;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px 60px;
            border-radius: 20px;
            font-size: 1.5rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: manipulation;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
            -webkit-tap-highlight-color: transparent;
        }
        
        @media (min-width: 768px) {
            .start-btn {
                padding: 24px 80px;
                font-size: 1.75rem;
                width: auto;
            }
        }
        
        .start-btn:active {
            transform: scale(0.98);
            box-shadow: 0 5px 20px rgba(16, 185, 129, 0.4);
        }
        
        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(16, 185, 129, 0.5);
        }
        
        .info-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        }
        
        /* Towers */
        .towers-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 40px 0;
            overflow-x: auto;
            padding: 20px 10px;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior-x: contain;
        }
        
        @media (min-width: 375px) {
            .towers-container {
                gap: 30px;
            }
        }
        
        @media (min-width: 768px) {
            .towers-container {
                gap: 60px;
                margin: 60px 0;
            }
        }
        
        .tower {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0;
        }
        
        .tower-label {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 16px;
            color: #667eea;
            letter-spacing: 0.5px;
        }
        
        @media (min-width: 768px) {
            .tower-label {
                font-size: 1.25rem;
                margin-bottom: 20px;
            }
        }
        
        .tower-body {
            position: relative;
            width: 100px;
            height: 180px;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border: 3px solid #e5e7eb;
            border-radius: 16px;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            padding-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }
        
        @media (min-width: 375px) {
            .tower-body {
                width: 110px;
                height: 200px;
            }
        }
        
        @media (min-width: 768px) {
            .tower-body {
                width: 200px;
                height: 320px;
                padding-bottom: 20px;
                border-radius: 20px;
            }
        }
        
        .tower-body:active {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }
        
        .tower-body.selected {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
            transform: scale(1.05);
        }
        
        .tower-pole {
            position: absolute;
            width: 6px;
            height: 100%;
            background: linear-gradient(180deg, #9ca3af 0%, #6b7280 100%);
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 0;
            border-radius: 3px;
        }
        
        @media (min-width: 768px) {
            .tower-pole { width: 10px; border-radius: 5px; }
        }
        
        .disc {
            height: 22px;
            border-radius: 12px;
            margin-bottom: 3px;
            position: relative;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.875rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        @media (min-width: 768px) {
            .disc {
                height: 36px;
                margin-bottom: 5px;
                font-size: 1.125rem;
                border-radius: 18px;
            }
        }
        
        .disc.selected {
            transform: scale(1.15);
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.5), 0 8px 16px rgba(0, 0, 0, 0.2);
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.5), 0 8px 16px rgba(0, 0, 0, 0.2); }
            50% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0.3), 0 8px 16px rgba(0, 0, 0, 0.2); }
        }
        
        .disc.d1 { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); width: 28px; }
        .disc.d2 { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); width: 36px; }
        .disc.d3 { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); width: 44px; }
        .disc.d4 { background: linear-gradient(135deg, #10b981 0%, #059669 100%); width: 52px; }
        .disc.d5 { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); width: 60px; }
        .disc.d6 { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); width: 68px; }
        .disc.d7 { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); width: 76px; }
        .disc.d8 { background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); width: 84px; }
        
        @media (min-width: 375px) {
            .disc.d1 { width: 30px; }
            .disc.d2 { width: 40px; }
            .disc.d3 { width: 50px; }
            .disc.d4 { width: 60px; }
            .disc.d5 { width: 70px; }
            .disc.d6 { width: 80px; }
            .disc.d7 { width: 90px; }
            .disc.d8 { width: 100px; }
        }
        
        @media (min-width: 768px) {
            .disc.d1 { width: 50px; }
            .disc.d2 { width: 70px; }
            .disc.d3 { width: 90px; }
            .disc.d4 { width: 110px; }
            .disc.d5 { width: 130px; }
            .disc.d6 { width: 150px; }
            .disc.d7 { width: 170px; }
            .disc.d8 { width: 190px; }
        }
        
        /* Stats */
        .stats {
            display: flex;
            justify-content: space-around;
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-radius: 16px;
        }
        
        @media (min-width: 768px) {
            .stats {
                font-size: 1.5rem;
                margin-bottom: 28px;
                padding: 24px;
            }
        }
        
        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Move Table */
        .move-table-container {
            max-width: 700px;
            margin: 0 auto;
            overflow-x: auto;
            height: 350px;
            overflow-y: auto;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            scroll-behavior: smooth;
        }
        
        /* Improve table scrolling on iOS */
        .move-table-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .move-table-container::-webkit-scrollbar-track {
            background: #f3f4f6;
            border-radius: 4px;
        }
        
        .move-table-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 4px;
        }
        
        .move-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .move-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 12px;
            font-size: 1.125rem;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        
        @media (min-width: 768px) {
            .move-table th {
                padding: 20px 16px;
                font-size: 1.25rem;
            }
        }
        
        .move-table td {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 8px;
            text-align: center;
        }
        
        @media (min-width: 768px) {
            .move-table td { padding: 16px 12px; }
        }
        
        .move-table .disc-col { color: #3b82f6; }
        .move-table .stick-col { color: #10b981; }
        
        .input-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            position: relative;
            z-index: 10;
        }
        
        .input-btn {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            font-weight: 800;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            touch-action: manipulation;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            -webkit-tap-highlight-color: transparent;
        }
        
        @media (min-width: 375px) {
            .input-btn {
                width: 65px;
                height: 65px;
                font-size: 1.75rem;
            }
        }
        
        @media (min-width: 768px) {
            .input-btn {
                width: 75px;
                height: 75px;
                font-size: 2rem;
            }
        }
        
        .input-btn:active {
            transform: scale(0.92);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        
        /* Buttons */
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 16px 28px;
            font-size: 1.125rem;
            font-weight: 700;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            touch-action: manipulation;
            flex: 1;
            min-width: 140px;
            max-width: 220px;
            -webkit-tap-highlight-color: transparent;
        }
        
        @media (min-width: 768px) {
            .btn {
                padding: 18px 36px;
                font-size: 1.25rem;
            }
        }
        
        .btn-green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        .btn-green:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .btn-yellow {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        .btn-yellow:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }
        
        .btn-purple {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }
        .btn-purple:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }
        .btn-purple:disabled {
            background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
            cursor: not-allowed;
            box-shadow: none;
        }
        
        .btn-gray {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
        }
        .btn-gray:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
        }
        
        .instruction {
            text-align: center;
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 20px;
            font-weight: 600;
            padding: 0 16px;
        }
        
        /* Keyboard hints - only show on devices with keyboard (hover capability) */
        .keyboard-hint {
            text-align: center;
            font-size: 0.875rem;
            color: #1f2937;
            font-weight: 700;
            display: none;
        }
        
        @media (hover: hover) and (pointer: fine) {
            .keyboard-hint {
                display: block;
            }
        }
        
        /* Timeline */
        .timeline-container {
            max-width: 900px;
            margin: 40px auto;
            padding: 32px;
            background: white;
            border-radius: 20px;
        }
        
        .timeline-header {
            text-align: center;
            margin-bottom: 32px;
        }
        
        .timeline-header h3 {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 12px;
        }
        
        .timeline-stats {
            display: flex;
            justify-content: center;
            gap: 32px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .timeline-stat {
            padding: 16px 24px;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-radius: 12px;
            text-align: center;
        }
        
        .timeline-stat-value {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 4px;
        }
        
        .timeline-stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 600;
        }
        
        .timeline {
            position: relative;
            padding: 20px 0;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }
        
        .timeline-item {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            position: relative;
        }
        
        .timeline-item.optimal {
            justify-content: flex-start;
        }
        
        .timeline-item.suboptimal {
            justify-content: flex-end;
        }
        
        .timeline-marker {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.875rem;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .timeline-item.optimal .timeline-marker {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .timeline-item.suboptimal .timeline-marker {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .timeline-content {
            padding: 16px 20px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 45%;
            transition: all 0.3s;
        }
        
        .timeline-content:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        
        .timeline-item.optimal .timeline-content {
            margin-right: 55%;
            border-left: 4px solid #10b981;
        }
        
        .timeline-item.suboptimal .timeline-content {
            margin-left: 55%;
            border-right: 4px solid #f59e0b;
        }
        
        .timeline-move {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .timeline-item.optimal .timeline-move {
            color: #10b981;
        }
        
        .timeline-item.suboptimal .timeline-move {
            color: #f59e0b;
        }
        
        .timeline-description {
            font-size: 0.875rem;
            color: #6b7280;
        }
        
        .result-card {
            border-radius: 24px;
            padding: 40px 24px;
            margin-bottom: 28px;
            text-align: center;
        }
        
        .result-card.success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
        }
        
        .result-card.fail {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
        }
        
        .result-title {
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 24px;
            letter-spacing: -0.5px;
        }
        
        @media (min-width: 768px) {
            .result-title { font-size: 3.5rem; }
        }
        
        .result-card.success .result-title {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .result-card.fail .result-title {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .result-stats {
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        @media (min-width: 768px) {
            .result-stats { font-size: 1.5rem; }
        }
        
        .result-stats div {
            margin: 16px 0;
        }
        
        /* Custom Error Modal */
        .error-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.2s ease-out;
            padding: 20px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .error-content {
            background: white;
            border-radius: 24px;
            padding: 40px 32px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.3s ease-out;
            text-align: center;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .error-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: shake 0.5s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px) rotate(-5deg); }
            75% { transform: translateX(10px) rotate(5deg); }
        }
        
        .error-title {
            font-size: 1.75rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 16px;
        }
        
        .error-message {
            font-size: 1.125rem;
            color: #374151;
            line-height: 1.6;
            margin-bottom: 24px;
            white-space: pre-line;
        }
        
        .error-rule {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            padding: 16px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            color: #991b1b;
            margin-bottom: 24px;
        }
        
        .error-button {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 16px 48px;
            border: none;
            border-radius: 16px;
            font-size: 1.25rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            -webkit-tap-highlight-color: transparent;
        }
        
        .error-button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }
        
        @media (min-width: 768px) {
            .error-content {
                padding: 48px 40px;
            }
            
            .error-icon {
                font-size: 5rem;
            }
            
            .error-title {
                font-size: 2.25rem;
            }
        }
        
        @media (max-width: 767px) {
            .timeline::before {
                left: 20px;
            }
            
            .timeline-marker {
                left: 20px;
            }
            
            .timeline-item.optimal,
            .timeline-item.suboptimal {
                justify-content: flex-end;
            }
            
            .timeline-content {
                width: calc(100% - 60px);
                margin-left: 60px !important;
                margin-right: 0 !important;
            }
            
            .timeline-item.optimal .timeline-content {
                border-left: 4px solid #10b981;
                border-right: none;
            }
            
            .timeline-item.suboptimal .timeline-content {
                border-left: 4px solid #f59e0b;
                border-right: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Setup Screen -->
        <div id="setupScreen">
            <div class="card">
                <h1>üéÆ Memory Tower of Hanoi</h1>
                
                <div class="label">SELECT NUMBER OF DISCS</div>
                <div class="disc-grid" id="discButtons"></div>
                
                <div class="label">SELECT DIFFICULTY LEVEL</div>
                <div class="diff-grid">
                    <button class="diff-btn easy active" onclick="selectDifficulty('easy')">
                        <div>EASY</div>
                        <div>Interactive gameplay</div>
                    </button>
                    <button class="diff-btn medium" onclick="selectDifficulty('medium')">
                        <div>MEDIUM</div>
                        <div>Visualize & solve mentally</div>
                    </button>
                    <button class="diff-btn hard" onclick="selectDifficulty('hard')">
                        <div>HARD</div>
                        <div>Empty towers challenge</div>
                    </button>
                    <button class="diff-btn expert" onclick="selectDifficulty('expert')">
                        <div>EXPERT</div>
                        <div>Pure memory mastery</div>
                    </button>
                </div>
                
                <button class="start-btn" onclick="startGame()">START GAME</button>
                
                <div style="display: flex; gap: 12px; margin: 20px auto 0; max-width: 400px; flex-wrap: wrap;">
                    <button onclick="showRules()" class="info-btn" style="flex: 1; min-width: 180px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 12px 24px; border: none; border-radius: 16px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                        üìã RULES
                    </button>
                    <button onclick="showBehindGame()" class="info-btn" style="flex: 1; min-width: 180px; background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); color: white; padding: 12px 24px; border: none; border-radius: 16px; font-size: 1rem; font-weight: 700; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);">
                        üìñ BEHIND THE GAME
                    </button>
                </div>
                
                <div class="keyboard-hint" style="margin-top: 24px; color: #1f2937; font-size: 0.95rem; font-weight: 700;">
                    üíª Desktop: Press 3-8 to select discs ‚Ä¢ Enter to start
                </div>
            </div>
        </div>
        
        <!-- Interactive Screen (Easy Mode) -->
        <div id="interactiveScreen" class="hidden">
            <div class="card">
                <h1>üéØ Easy Mode</h1>
                <h2><span id="easyDiscs"></span> Discs Challenge</h2>
                <div class="stats">
                    <div class="stat-item">‚è±Ô∏è <span id="easyTime">0:00</span></div>
                    <div class="stat-item">üéØ <span id="easyMoves">0</span> Moves</div>
                </div>
                <div class="instruction" id="easyInstruction">Click a tower to select the top disc</div>
                <div class="keyboard-hint" style="color: #1f2937; font-weight: 700; font-size: 0.875rem;">
                    üíª Keyboard: 1, 2, 3 for towers ‚Ä¢ R to reset
                </div>
            </div>
            
            <div class="card">
                <div class="towers-container" id="easyTowers"></div>
                <div class="action-buttons">
                    <button class="btn btn-yellow" onclick="resetEasy()">üîÑ RESET</button>
                    <button class="btn btn-gray" onclick="backToMenu()">üè† MENU</button>
                </div>
            </div>
        </div>
        
        <!-- Memory Mode Screen -->
        <div id="memoryScreen" class="hidden">
            <div class="card">
                <h1 id="memoryTitle">üß† Memory Mode</h1>
                <h2 id="memorySubtitle"></h2>
                <div class="stats">
                    <div class="stat-item">‚è±Ô∏è <span id="memoryTime">0:00</span></div>
                    <div class="stat-item">üéØ <span id="memoryMoves">0</span> Moves</div>
                </div>
            </div>
            
            <div class="card" id="visualReference">
                <div class="towers-container" id="memoryTowers"></div>
            </div>
            
            <div class="card hidden" id="noVisualReference">
                <div style="text-align: center; padding: 80px 20px; background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border-radius: 20px;">
                    <div style="font-size: 2rem; font-weight: 800; color: #667eea; margin-bottom: 16px;">üéØ EXPERT MODE</div>
                    <div style="font-size: 1.125rem; color: #6b7280;">
                        Solve <span id="expertDiscs" style="font-weight: 700; color: #667eea;"></span> discs using pure memory
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h2>üìã Move Record</h2>
                <div style="text-align: center; font-size: 0.875rem; color: #667eea; margin-bottom: 8px; font-weight: 600;">
                    Numbered history of all moves - Always visible
                </div>
                <div style="text-align: center; font-size: 0.8rem; color: #6b7280; font-weight: 500; line-height: 1.4; margin-bottom: 20px;">
                    Use this record to mentally track where each disc is positioned<br>
                    Visual checks are limited, but you can review this record anytime
                </div>
                <div class="keyboard-hint" style="color: #1f2937; font-size: 0.875rem; font-weight: 700; line-height: 1.4; margin-bottom: 20px;">
                    üíª Keyboard: Numbers to play ‚Ä¢ R to reset ‚Ä¢ C to check ‚Ä¢ ESC to cancel
                </div>
                <div class="move-table-container">
                    <table class="move-table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>DISC</th>
                                <th>TO</th>
                                <th>STICK</th>
                            </tr>
                        </thead>
                        <tbody id="moveTableBody"></tbody>
                    </table>
                </div>
                
                <div id="currentInputDisplay" style="margin: 20px 0;"></div>
                
                <div id="inputButtons" style="margin: 24px 0;"></div>
                
                <div class="action-buttons">
                    <button class="btn btn-yellow" onclick="resetMemory()">üîÑ RESET</button>
                    <button class="btn btn-purple" id="checkStatusBtn" onclick="checkSolution()">üëÅÔ∏è VISUAL CHECK</button>
                    <button class="btn btn-gray" onclick="backToMenu()">üè† MENU</button>
                </div>
            </div>
        </div>
        
        <!-- Result Screen -->
        <div id="resultScreen" class="hidden">
            <div id="resultCard" class="result-card">
                <div class="result-title" id="resultTitle"></div>
                <div class="result-stats" id="resultStats"></div>
            </div>
            
            <div class="card">
                <h2>üèÜ Final Result</h2>
                <div class="towers-container" id="resultTowers"></div>
                
                <div style="margin-top: 32px;">
                    <div class="action-buttons" id="resultButtons"></div>
                </div>
            </div>
            
            <div id="timelineContainer" class="hidden"></div>
        </div>
        
        <!-- Behind Game Screen -->
        <div id="behindGameScreen" class="screen hidden">
            <div class="card" style="max-width: 800px; margin: 0 auto; max-height: 80vh; overflow-y: auto;">
                <h1 style="text-align: center; color: #667eea; margin-bottom: 30px; font-size: 2rem;">Behind the Game</h1>
                
                <div style="line-height: 1.8; color: #374151; font-size: 0.95rem;">
                    <h2 style="color: #667eea; font-size: 1.35rem; margin: 30px 0 20px 0;">Memory Tower of Hanoi</h2>
                    <p style="margin-bottom: 20px;"><strong>Created by Mike S. (Kyla's Dad)</strong></p>
                    
                    <p style="margin-bottom: 20px;">This variation of the Tower of Hanoi was created by Mike Saffaie with a specific purpose: to strengthen his daughter's‚Äîand eventually his son's‚Äîreasoning abilities during the most developmentally sensitive years of childhood.</p>
                    
                    <p style="margin-bottom: 20px;">At a young age, children's minds are still forming the cognitive structures that will govern how they think, solve problems, and make decisions for the rest of their lives. As parents, we want the best for our kids in every facet‚Äînot only in <em>what they know</em>, but in <em>how they think</em>.</p>
                    
                    <p style="margin-bottom: 20px;">Mike approached this with a foundational distinction:</p>
                    
                    <div style="background: #f3f4f6; padding: 20px; border-radius: 12px; margin: 20px 0;">
                        <p style="margin-bottom: 15px;"><strong style="color: #667eea;">Knowledge is largely static.</strong><br>
                        For example, knowing that there are 50 states in the United States is a stored fact.</p>
                        
                        <p style="margin-bottom: 0;"><strong style="color: #667eea;">Reasoning is dynamic.</strong><br>
                        Reasoning can be defined simply and accurately as: <em>the process of transforming information into conclusions through structured thought, rules, and relationships.</em></p>
                    </div>
                    
                    <p style="margin-bottom: 20px;">Mike believes the <strong>process</strong> by which someone arrives at a conclusion is more important than the conclusion itself. A correct answer reached by an unreliable or poorly understood method is fragile. As the saying goes, "Even a broken clock is right twice a day." Getting the right answer does not guarantee sound thinking.</p>
                    
                    <p style="margin-bottom: 20px;">For this reason, learning isolated facts about the world mattered less to Mike than developing the ability to <em>process information</em> in a way that leads to justified, understood conclusions.</p>
                    
                    <p style="margin-bottom: 20px;">The classic Tower of Hanoi provided a perfect foundation. It is tactile, visual, and engaging‚Äîusing colors, shapes, and physical movement while also demanding planning and rule following. At a very young age, Mike's daughter Kyla showed remarkable ability with the game.</p>
                    
                    <p style="margin-bottom: 20px;">One day, Mike asked Kyla to attempt something different:</p>
                    
                    <p style="text-align: center; font-size: 1.15rem; color: #667eea; font-weight: 700; margin: 30px 0; font-style: italic;">solve the Tower of Hanoi without looking.</p>
                    
                    <p style="margin-bottom: 20px;">She succeeded.</p>
                    
                    <p style="margin-bottom: 20px;">As of the time of this writing, Kyla at five years old can solve four disks without visual reference. Importantly, she does not rely on memorized patterns. In fact, she often makes moves that increase the total number of steps beyond the minimum required. This was Mike's favorite outcome.</p>
                    
                    <p style="margin-bottom: 20px;"><strong>Why?</strong></p>
                    
                    <p style="margin-bottom: 20px;">Because it demonstrated something far more valuable than efficiency:</p>
                    
                    <p style="text-align: center; font-size: 1.05rem; color: #10b981; font-weight: 700; margin: 30px 0;">Kyla was actively representing the game in her mind.</p>
                    
                    <p style="margin-bottom: 20px;">She was <em>reasoning through the problem internally</em>‚Äîtracking positions, consequences, and constraints‚Äîrather than executing a rehearsed sequence. The added moves were not errors; they were evidence of genuine mental simulation.</p>
                    
                    <p style="margin-bottom: 20px;">For Mike, this confirmed the core insight behind Memory Tower of Hanoi:</p>
                    
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 16px; margin: 30px 0; text-align: center;">
                        <p style="font-size: 1.05rem; font-weight: 700; margin: 0; line-height: 1.6;">The goal is not optimization‚Äî<br>it is cognitive engagement, internal modeling,<br>and reasoned decision-making.</p>
                    </div>
                    
                    <p style="margin-bottom: 20px;">This game was created to cultivate those abilities, and it is shared in the hope that parents‚Äîand even non-parents‚Äîcan appreciate and use it as a tool to strengthen reasoning where it matters most.</p>
                    
                    <p style="text-align: center; font-size: 1.5rem; margin-top: 40px; color: #667eea;">Enjoy üôÇ</p>
                </div>
                
                <div style="text-align: center; margin-top: 40px;">
                    <button class="btn" onclick="showSetup()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                        üè† BACK TO MENU
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Rules Screen -->
        <div id="rulesScreen" class="screen hidden">
            <div class="card" style="max-width: 700px; margin: 0 auto;">
                <h1 style="text-align: center; color: #3b82f6; margin-bottom: 30px; font-size: 2rem;">üìã How to Play</h1>
                
                <div style="line-height: 1.8; color: #374151; font-size: 1.05rem;">
                    
                    <h2 style="color: #3b82f6; font-size: 1.4rem; margin: 30px 0 15px 0;">üéØ The Goal</h2>
                    <p style="margin-bottom: 25px; font-size: 1.1rem;">Move all discs from Stick 1 to Stick 3.</p>
                    
                    <h2 style="color: #3b82f6; font-size: 1.4rem; margin: 30px 0 15px 0;">‚ö†Ô∏è The Rules</h2>
                    <div style="background: #f3f4f6; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                        <p style="margin-bottom: 15px; font-size: 1.05rem;">‚úì Move one disc at a time</p>
                        <p style="margin-bottom: 15px; font-size: 1.05rem;">‚úì Only move the top disc from a stick</p>
                        <p style="margin-bottom: 0; font-size: 1.05rem;">‚úó Never put a big disc on top of a small disc</p>
                    </div>
                    
                    <h2 style="color: #3b82f6; font-size: 1.4rem; margin: 30px 0 15px 0;">üéÆ Game Modes</h2>
                    
                    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h3 style="font-size: 1.2rem; margin: 0 0 10px 0;">üü¢ EASY</h3>
                        <p style="margin: 0; font-size: 1rem;">See the towers. Click to move discs. Perfect for learning!</p>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h3 style="font-size: 1.2rem; margin: 0 0 10px 0;">üü° MEDIUM</h3>
                        <p style="margin: 0; font-size: 1rem;">See the start. Solve in your head. Type your moves. Limited checks!</p>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 15px;">
                        <h3 style="font-size: 1.2rem; margin: 0 0 10px 0;">üî¥ HARD</h3>
                        <p style="margin: 0; font-size: 1rem;">Empty towers shown. Picture it all in your mind. Very limited checks!</p>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
                        <h3 style="font-size: 1.2rem; margin: 0 0 10px 0;">üü£ EXPERT</h3>
                        <p style="margin: 0; font-size: 1rem;">No towers at all! Pure memory. Can you do it?</p>
                    </div>
                    
                    <h2 style="color: #3b82f6; font-size: 1.4rem; margin: 30px 0 15px 0;">üí° Tips</h2>
                    <div style="background: #e0f2fe; padding: 20px; border-radius: 12px; border-left: 4px solid #3b82f6;">
                        <p style="margin-bottom: 12px; font-size: 1rem;">‚Ä¢ Start with Easy mode to learn</p>
                        <p style="margin-bottom: 12px; font-size: 1rem;">‚Ä¢ Use fewer discs when learning</p>
                        <p style="margin-bottom: 12px; font-size: 1rem;">‚Ä¢ In memory modes, write down where each disc is</p>
                        <p style="margin-bottom: 0; font-size: 1rem;">‚Ä¢ Don't rush - think before each move!</p>
                    </div>
                    
                </div>
                
                <div style="text-align: center; margin-top: 40px;">
                    <button class="btn" onclick="showSetup()" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                        üè† BACK TO MENU
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let state = {
            numDiscs: 3,
            difficulty: 'easy',
            towers: [[], [], []],
            moves: [],
            optimalMoves: [],
            startTime: null,
            timerInterval: null,
            selectedTower: null,
            currentInput: '',
            checksRemaining: 0
        };

        function initDiscButtons() {
            const container = document.getElementById('discButtons');
            container.innerHTML = '';
            
            for (let i = 3; i <= 8; i++) {
                const btn = document.createElement('button');
                btn.className = 'disc-btn' + (i === state.numDiscs ? ' active' : '');
                btn.textContent = i;
                btn.onclick = () => {
                    state.numDiscs = i;
                    initDiscButtons();
                };
                container.appendChild(btn);
            }
        }

        function selectDifficulty(diff) {
            state.difficulty = diff;
            document.querySelectorAll('.diff-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.diff-btn.' + diff).classList.add('active');
        }

        function initTowers() {
            state.towers = [
                Array.from({ length: state.numDiscs }, (_, i) => state.numDiscs - i),
                [],
                []
            ];
            state.optimalMoves = generateOptimalSolution(state.numDiscs);
        }

        function generateOptimalSolution(n, from = 0, to = 2, aux = 1, moves = []) {
            if (n === 1) {
                moves.push({ disc: 1, from, to });
                return moves;
            }
            generateOptimalSolution(n - 1, from, aux, to, moves);
            moves.push({ disc: n, from, to });
            generateOptimalSolution(n - 1, aux, to, from, moves);
            return moves;
        }

        function renderTowers(containerId, interactive = false, showDiscs = true) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            const displayTowers = showDiscs ? state.towers : [[], [], []];
            
            displayTowers.forEach((tower, towerIndex) => {
                const towerDiv = document.createElement('div');
                towerDiv.className = 'tower';
                
                const label = document.createElement('div');
                label.className = 'tower-label';
                label.textContent = `STICK ${towerIndex + 1}`;
                towerDiv.appendChild(label);
                
                const body = document.createElement('div');
                body.className = 'tower-body';
                if (interactive && state.selectedTower === towerIndex) {
                    body.classList.add('selected');
                }
                
                const pole = document.createElement('div');
                pole.className = 'tower-pole';
                body.appendChild(pole);
                
                tower.forEach((disc, discIndex) => {
                    const discDiv = document.createElement('div');
                    discDiv.className = `disc d${disc}`;
                    const isTop = discIndex === tower.length - 1;
                    if (interactive && isTop && state.selectedTower === towerIndex) {
                        discDiv.classList.add('selected');
                    }
                    discDiv.textContent = disc;
                    body.appendChild(discDiv);
                });
                
                if (interactive) {
                    body.onclick = () => handleTowerClick(towerIndex);
                }
                
                towerDiv.appendChild(body);
                container.appendChild(towerDiv);
            });
        }

        function handleTowerClick(index) {
            if (state.selectedTower === null) {
                if (state.towers[index].length > 0) {
                    state.selectedTower = index;
                    updateEasyUI();
                }
            } else {
                if (state.selectedTower === index) {
                    state.selectedTower = null;
                    updateEasyUI();
                } else {
                    const disc = state.towers[state.selectedTower][state.towers[state.selectedTower].length - 1];
                    const target = state.towers[index];
                    
                    // RULE: Cannot place larger disc on smaller disc
                    if (target.length === 0 || disc < target[target.length - 1]) {
                        state.towers[state.selectedTower].pop();
                        state.towers[index].push(disc);
                        state.moves.push({ disc, from: state.selectedTower, to: index });
                        
                        state.selectedTower = null;
                        updateEasyUI();
                        
                        setTimeout(() => {
                            if (checkWin()) {
                                showResult();
                            }
                        }, 100);
                    } else {
                        alert(`‚ùå Invalid Move! Cannot place disc ${disc} on disc ${target[target.length - 1]}.\n\nRule: Larger discs cannot go on smaller discs.`);
                    }
                }
            }
        }

        function updateEasyUI() {
            updateTime('easyTime');
            document.getElementById('easyMoves').textContent = state.moves.length;
            
            const instruction = document.getElementById('easyInstruction');
            if (state.selectedTower === null) {
                instruction.textContent = 'Click a tower to select the top disc';
                instruction.style.color = '#667eea';
            } else {
                const disc = state.towers[state.selectedTower][state.towers[state.selectedTower].length - 1];
                instruction.textContent = `Disc ${disc} selected - Click destination tower`;
                instruction.style.color = '#f59e0b';
            }
            
            renderTowers('easyTowers', true);
        }

        function updateTime(elementId) {
            const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
            const mins = Math.floor(elapsed / 60);
            const secs = elapsed % 60;
            document.getElementById(elementId).textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function updateMemoryUI() {
            updateTime('memoryTime');
            document.getElementById('memoryMoves').textContent = state.moves.length;
            updateMoveTable();
        }

        function updateMoveTable() {
            const tbody = document.getElementById('moveTableBody');
            tbody.innerHTML = '';
            
            // Show ONLY completed moves with move numbers in the scrollable table
            if (state.moves.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="4" style="padding: 40px; text-align: center; color: #9ca3af; font-style: italic;">
                        No moves recorded yet - Start by selecting a disc!
                    </td>
                `;
                tbody.appendChild(emptyRow);
            } else {
                state.moves.forEach((move, index) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="color: #667eea; font-weight: 800; font-size: 1rem;">${index + 1}</td>
                        <td class="disc-col" style="font-weight: 700; font-size: 1.25rem;">${move.disc}</td>
                        <td style="color: #9ca3af; font-weight: 700;">‚Üí</td>
                        <td class="stick-col" style="font-weight: 700; font-size: 1.25rem;">${move.to + 1}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
            
            // Update current input display (outside table)
            updateCurrentInputDisplay();
            
            // Update input buttons based on current input state
            updateInputButtons();
        }
        
        function updateCurrentInputDisplay() {
            const container = document.getElementById('currentInputDisplay');
            const parts = state.currentInput.split('');
            
            container.innerHTML = `
                <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 16px; padding: 20px; margin-bottom: 20px; border: 2px solid #f59e0b;">
                    <div style="text-align: center; font-size: 0.75rem; font-weight: 700; color: #92400e; letter-spacing: 1px; margin-bottom: 12px;">NEXT MOVE</div>
                    <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 16px; align-items: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: #3b82f6; font-weight: 600; margin-bottom: 8px;">DISC</div>
                            <div style="font-size: 1.75rem; font-weight: 800; color: #3b82f6;">${parts[0] || '?'}</div>
                        </div>
                        <div style="color: #9ca3af; font-size: 1.5rem; font-weight: 700;">‚Üí</div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.75rem; color: #10b981; font-weight: 600; margin-bottom: 8px;">STICK</div>
                            <div style="font-size: 1.75rem; font-weight: 800; color: #10b981;">${parts[1] || '?'}</div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function updateInputButtons() {
            const inputButtons = document.getElementById('inputButtons');
            inputButtons.innerHTML = '';
            inputButtons.className = 'input-buttons';
            
            if (state.currentInput.length === 0) {
                // First input - show disc buttons (1 to numDiscs)
                const label = document.createElement('div');
                label.style.cssText = 'width: 100%; text-align: center; font-weight: 700; color: #3b82f6; margin-bottom: 12px; font-size: 0.875rem;';
                label.textContent = 'SELECT DISC NUMBER';
                inputButtons.appendChild(label);
                
                const buttonsDiv = document.createElement('div');
                buttonsDiv.style.cssText = 'display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;';
                
                for (let i = 1; i <= state.numDiscs; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'input-btn';
                    btn.textContent = i;
                    btn.onclick = () => handleInput(i.toString());
                    buttonsDiv.appendChild(btn);
                }
                inputButtons.appendChild(buttonsDiv);
            } else if (state.currentInput.length === 1) {
                // Second input - show stick buttons (1, 2, 3)
                const label = document.createElement('div');
                label.style.cssText = 'width: 100%; text-align: center; font-weight: 700; color: #10b981; margin-bottom: 12px; font-size: 0.875rem;';
                label.textContent = `MOVE DISC ${state.currentInput} TO STICK`;
                inputButtons.appendChild(label);
                
                const buttonsDiv = document.createElement('div');
                buttonsDiv.style.cssText = 'display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; align-items: center;';
                
                for (let i = 1; i <= 3; i++) {
                    const btn = document.createElement('button');
                    btn.className = 'input-btn';
                    btn.textContent = i;
                    btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
                    btn.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.3)';
                    btn.onclick = () => handleInput(i.toString());
                    buttonsDiv.appendChild(btn);
                }
                
                // Add cancel button
                const cancelBtn = document.createElement('button');
                cancelBtn.className = 'input-btn';
                cancelBtn.textContent = '‚úï';
                cancelBtn.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
                cancelBtn.style.boxShadow = '0 4px 12px rgba(239, 68, 68, 0.3)';
                cancelBtn.onclick = () => {
                    state.currentInput = '';
                    updateMoveTable();
                };
                buttonsDiv.appendChild(cancelBtn);
                
                inputButtons.appendChild(buttonsDiv);
            }
        }

        function simulateMoves() {
            const towers = [
                Array.from({ length: state.numDiscs }, (_, i) => state.numDiscs - i),
                [],
                []
            ];
            
            for (const move of state.moves) {
                const disc = move.disc;
                let fromTower = -1;
                
                for (let i = 0; i < 3; i++) {
                    const index = towers[i].indexOf(disc);
                    if (index !== -1) {
                        fromTower = i;
                        towers[i].splice(index, 1);
                        break;
                    }
                }
                
                if (fromTower !== -1) {
                    towers[move.to].push(disc);
                }
            }
            
            return towers;
        }

        function validateMove(disc, currentTowers) {
            // Check if disc is on top
            let discIsOnTop = false;
            let fromTower = -1;
            
            for (let i = 0; i < 3; i++) {
                if (currentTowers[i].length > 0 && currentTowers[i][currentTowers[i].length - 1] === disc) {
                    discIsOnTop = true;
                    fromTower = i;
                    break;
                }
            }
            
            return { valid: discIsOnTop, fromTower };
        }

        function validatePlacement(disc, targetTower) {
            // RULE: Cannot place larger disc on smaller disc
            if (targetTower.length === 0) return true;
            return disc < targetTower[targetTower.length - 1];
        }

        function handleInput(num) {
            state.currentInput += num;
            
            if (state.currentInput.length === 2) {
                const disc = parseInt(state.currentInput[0]);
                const stick = parseInt(state.currentInput[1]);
                
                console.log('Attempting move: Disc', disc, 'to Stick', stick);
                
                // Validate disc number
                if (disc < 1 || disc > state.numDiscs) {
                    state.currentInput = '';
                    updateMoveTable();
                    if (disc < 1) {
                        alert(`‚ùå INVALID DISC!\n\nDisc ${disc} doesn't exist.\n\nValid discs: 1 to ${state.numDiscs}`);
                    } else {
                        alert(`‚ùå INVALID DISC!\n\nDisc ${disc} doesn't exist in a ${state.numDiscs}-disc game!\n\nValid discs: 1 to ${state.numDiscs}`);
                    }
                    return;
                }
                
                // Validate stick number
                if (stick < 1 || stick > 3) {
                    state.currentInput = '';
                    updateMoveTable();
                    alert(`‚ùå INVALID STICK!\n\nStick ${stick} doesn't exist!\n\nOnly 3 sticks available: Stick 1, Stick 2, Stick 3`);
                    return;
                }
                
                // Get current state after simulating all previous moves
                const currentTowers = simulateMoves();
                console.log('Current towers:', currentTowers);
                
                // Find where this disc currently is
                let discFoundOnStick = -1;
                let discPosition = -1;
                for (let i = 0; i < 3; i++) {
                    const index = currentTowers[i].indexOf(disc);
                    if (index !== -1) {
                        discFoundOnStick = i;
                        discPosition = index;
                        break;
                    }
                }
                
                console.log('Disc', disc, 'found on stick', discFoundOnStick + 1, 'at position', discPosition);
                
                // Check if disc is on top (must be last element in array)
                const isOnTop = discFoundOnStick !== -1 && discPosition === currentTowers[discFoundOnStick].length - 1;
                
                console.log('Is disc', disc, 'on top?', isOnTop);
                
                if (!isOnTop) {
                    state.currentInput = '';
                    updateMoveTable();
                    
                    // Build detailed error message
                    let errorMsg = '';
                    if (discFoundOnStick === -1) {
                        errorMsg = `‚ùå INVALID MOVE!\n\nDisc ${disc} is not on any stick! Something went wrong.`;
                    } else {
                        const discsAbove = currentTowers[discFoundOnStick].length - 1 - discPosition;
                        const topDisc = currentTowers[discFoundOnStick][currentTowers[discFoundOnStick].length - 1];
                        
                        errorMsg = `‚ùå INVALID MOVE!\n\n`;
                        errorMsg += `Disc ${disc} is on Stick ${discFoundOnStick + 1}, but it's BURIED!\n\n`;
                        errorMsg += `There are ${discsAbove} disc${discsAbove > 1 ? 's' : ''} on top of it.\n`;
                        errorMsg += `The top disc on Stick ${discFoundOnStick + 1} is disc ${topDisc}.\n\n`;
                        errorMsg += `RULE: You can ONLY move the top disc from each stick.`;
                    }
                    
                    console.log('Showing error:', errorMsg);
                    alert(errorMsg);
                    return;
                }
                
                // Check placement rule - cannot place larger on smaller
                const targetTower = currentTowers[stick - 1];
                if (targetTower.length > 0 && disc > targetTower[targetTower.length - 1]) {
                    state.currentInput = '';
                    updateMoveTable();
                    const targetDisc = targetTower[targetTower.length - 1];
                    const errorMsg = `‚ùå INVALID MOVE!\n\nCannot place disc ${disc} on disc ${targetDisc}.\n\nRULE: Larger discs (higher numbers) CANNOT go on smaller discs (lower numbers).\n\nDisc ${disc} > Disc ${targetDisc} = ILLEGAL!`;
                    console.log('Showing error:', errorMsg);
                    alert(errorMsg);
                    return;
                }
                
                // Valid move!
                console.log('Move is VALID! Adding to moves list.');
                state.moves.push({ disc: disc, to: stick - 1 });
                state.currentInput = '';
                updateMemoryUI();
                
                setTimeout(() => {
                    const minMoves = Math.pow(2, state.numDiscs) - 1;
                    if (state.moves.length >= minMoves) {
                        const testTowers = simulateMoves();
                        if (checkWinTowers(testTowers)) {
                            if (state.timerInterval) {
                                clearInterval(state.timerInterval);
                                state.timerInterval = null;
                            }
                            state.towers = testTowers;
                            showResult();
                        }
                    }
                }, 100);
            } else {
                // Just added first digit, update to show stick buttons
                updateMoveTable();
            }
        }

        function checkWin() {
            return checkWinTowers(state.towers);
        }

        function checkWinTowers(towers) {
            if (towers[2].length !== state.numDiscs) return false;
            for (let i = 0; i < towers[2].length; i++) {
                if (towers[2][i] !== state.numDiscs - i) return false;
            }
            return true;
        }

        function checkSolution() {
            if (state.checksRemaining <= 0) return;
            
            state.checksRemaining--;
            updateCheckButton();
            
            state.towers = simulateMoves();
            const isWin = checkWin();
            
            if (isWin) {
                if (state.timerInterval) {
                    clearInterval(state.timerInterval);
                    state.timerInterval = null;
                }
                showResult();
            } else {
                showResult();
            }
        }

        function updateCheckButton() {
            const btn = document.getElementById('checkStatusBtn');
            if (btn) {
                btn.textContent = `üëÅÔ∏è VISUAL CHECK (${state.checksRemaining})`;
                btn.disabled = state.checksRemaining <= 0;
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function analyzeMoves() {
            const analysis = [];
            const minMoves = Math.pow(2, state.numDiscs) - 1;
            
            // A move is optimal only if it matches the optimal sequence at that position
            state.moves.forEach((move, index) => {
                let isOptimal = false;
                
                // Check if this move matches the optimal solution at this position
                if (index < state.optimalMoves.length) {
                    const optimalMove = state.optimalMoves[index];
                    isOptimal = (move.disc === optimalMove.disc && move.to === optimalMove.to);
                }
                
                analysis.push({
                    moveNum: index + 1,
                    disc: move.disc,
                    to: move.to,
                    optimal: isOptimal,
                    description: isOptimal ? 
                        'Optimal move - matches perfect solution' : 
                        'Suboptimal - deviates from perfect path'
                });
            });
            
            return analysis;
        }

        function renderTimeline(analysis) {
            const container = document.getElementById('timelineContainer');
            container.className = 'timeline-container';
            container.classList.remove('hidden');
            
            const optimalCount = analysis.filter(a => a.optimal).length;
            const suboptimalCount = analysis.length - optimalCount;
            const minMoves = Math.pow(2, state.numDiscs) - 1;
            const efficiency = Math.round((minMoves / state.moves.length) * 100);
            
            container.innerHTML = `
                <div class="timeline-header">
                    <h3>üìä Move Analysis</h3>
                    <div class="timeline-stats">
                        <div class="timeline-stat">
                            <div class="timeline-stat-value" style="color: #10b981;">${optimalCount}</div>
                            <div class="timeline-stat-label">Optimal Moves</div>
                        </div>
                        <div class="timeline-stat">
                            <div class="timeline-stat-value" style="color: #f59e0b;">${suboptimalCount}</div>
                            <div class="timeline-stat-label">Extra Moves</div>
                        </div>
                        <div class="timeline-stat">
                            <div class="timeline-stat-value" style="color: #667eea;">${efficiency}%</div>
                            <div class="timeline-stat-label">Efficiency</div>
                        </div>
                    </div>
                </div>
                <div class="timeline">
                    ${analysis.map(a => `
                        <div class="timeline-item ${a.optimal ? 'optimal' : 'suboptimal'}">
                            <div class="timeline-marker">${a.moveNum}</div>
                            <div class="timeline-content">
                                <div class="timeline-move">Disc ${a.disc} ‚Üí Stick ${a.to + 1}</div>
                                <div class="timeline-description">${a.description}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function showResult() {
            const wasTimerRunning = state.timerInterval !== null;
            
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
            
            const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
            const isWin = checkWin();
            
            showScreen('resultScreen');
            
            const card = document.getElementById('resultCard');
            card.className = 'result-card ' + (isWin ? 'success' : 'fail');
            
            document.getElementById('resultTitle').textContent = 
                isWin ? 'üéâ CONGRATULATIONS!' : '‚ùå NOT QUITE!';
            
            const difficultyNames = {
                easy: 'EASY',
                medium: 'MEDIUM',
                hard: 'HARD',
                expert: 'EXPERT'
            };
            
            const minMoves = Math.pow(2, state.numDiscs) - 1;
            
            document.getElementById('resultStats').innerHTML = `
                <div style="margin-bottom: 20px; font-size: 1.3rem; color: #667eea; font-weight: 800;">
                    ${state.numDiscs} Discs ‚Ä¢ ${difficultyNames[state.difficulty]} Mode
                </div>
                <div>‚è±Ô∏è Time: ${formatTime(elapsed)}</div>
                <div>üéØ Moves: ${state.moves.length} ${isWin && state.moves.length === minMoves ? '(Perfect!)' : ''}</div>
                ${isWin ? `<div style="margin-top: 20px; color: #10b981; font-size: 1.125rem;">‚ú® Perfect Solution!</div>` : 
                    `<div style="margin-top: 20px; color: #f59e0b; font-size: 1.125rem;">Keep trying!</div>`}
            `;
            
            renderTowers('resultTowers');
            
            const buttons = document.getElementById('resultButtons');
            buttons.innerHTML = '';
            
            if (!isWin && wasTimerRunning) {
                const continueBtn = document.createElement('button');
                continueBtn.className = 'btn btn-green';
                continueBtn.textContent = '‚ñ∂Ô∏è CONTINUE';
                continueBtn.onclick = () => {
                    showScreen('memoryScreen');
                    state.timerInterval = setInterval(() => updateMemoryUI(), 1000);
                    updateMemoryUI();
                    updateCheckButton();
                };
                buttons.appendChild(continueBtn);
            }
            
            if (!isWin) {
                const tryAgain = document.createElement('button');
                tryAgain.className = 'btn btn-yellow';
                tryAgain.textContent = 'üîÑ TRY AGAIN';
                tryAgain.onclick = () => {
                    initTowers();
                    startGame();
                };
                buttons.appendChild(tryAgain);
            }
            
            const playAgain = document.createElement('button');
            playAgain.className = isWin ? 'btn btn-green' : 'btn btn-gray';
            playAgain.textContent = isWin ? 'üéÆ PLAY AGAIN' : 'üè† MENU';
            playAgain.onclick = backToMenu;
            buttons.appendChild(playAgain);
            
            // Show timeline for wins
            if (isWin && state.difficulty !== 'easy') {
                const analysis = analyzeMoves();
                renderTimeline(analysis);
            } else {
                document.getElementById('timelineContainer').classList.add('hidden');
            }
        }

        function startGame() {
            initTowers();
            state.moves = [];
            state.startTime = Date.now();
            state.selectedTower = null;
            state.currentInput = '';
            state.checksRemaining = state.numDiscs;
            
            if (state.timerInterval) clearInterval(state.timerInterval);
            
            if (state.difficulty === 'easy') {
                showScreen('interactiveScreen');
                document.getElementById('easyDiscs').textContent = state.numDiscs;
                state.timerInterval = setInterval(() => updateEasyUI(), 1000);
                updateEasyUI();
            } else {
                showScreen('memoryScreen');
                
                const titles = {
                    medium: 'üß† Medium Mode',
                    hard: 'üî• Hard Mode',
                    expert: 'üíé Expert Mode'
                };
                const subtitles = {
                    medium: `${state.numDiscs} Discs - Visualize and solve mentally`,
                    hard: `${state.numDiscs} Discs - Empty towers challenge`,
                    expert: `${state.numDiscs} Discs - Pure memory mastery`
                };
                
                document.getElementById('memoryTitle').textContent = titles[state.difficulty];
                document.getElementById('memorySubtitle').textContent = subtitles[state.difficulty];
                
                if (state.difficulty === 'expert') {
                    document.getElementById('visualReference').classList.add('hidden');
                    document.getElementById('noVisualReference').classList.remove('hidden');
                    document.getElementById('expertDiscs').textContent = state.numDiscs;
                } else {
                    document.getElementById('visualReference').classList.remove('hidden');
                    document.getElementById('noVisualReference').classList.add('hidden');
                    renderTowers('memoryTowers', false, state.difficulty === 'medium');
                }
                
                state.timerInterval = setInterval(() => updateMemoryUI(), 1000);
                updateMemoryUI();
                updateCheckButton();
            }
        }

        function resetEasy() {
            initTowers();
            state.moves = [];
            state.selectedTower = null;
            state.startTime = Date.now();
            updateEasyUI();
        }

        function resetMemory() {
            state.moves = [];
            state.currentInput = '';
            state.startTime = Date.now();
            state.checksRemaining = state.numDiscs;
            updateMemoryUI();
            updateCheckButton();
        }

        function backToMenu() {
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
            showScreen('setupScreen');
        }
        
        function showSetup() {
            backToMenu();
        }
        
        function showBehindGame() {
            showScreen('behindGameScreen');
        }
        
        function showRules() {
            showScreen('rulesScreen');
        }

        function showScreen(screenId) {
            ['setupScreen', 'interactiveScreen', 'memoryScreen', 'resultScreen', 'behindGameScreen', 'rulesScreen'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
        }

        initDiscButtons();
        
        // Add keyboard support for desktop
        document.addEventListener('keydown', function(event) {
            const key = event.key;
            const num = parseInt(key);
            
            // Setup screen - select number of discs with 3-8 keys
            const setupScreen = document.getElementById('setupScreen');
            if (!setupScreen.classList.contains('hidden')) {
                if (num >= 3 && num <= 8) {
                    state.numDiscs = num;
                    initDiscButtons();
                }
                // Enter key to start game
                if (key === 'Enter') {
                    startGame();
                }
                return;
            }
            
            // Easy mode - use 1, 2, 3 keys to select towers
            const easyScreen = document.getElementById('interactiveScreen');
            if (!easyScreen.classList.contains('hidden')) {
                if (num >= 1 && num <= 3) {
                    handleTowerClick(num - 1);
                }
                // R key to reset
                if (key.toLowerCase() === 'r') {
                    resetEasy();
                }
                return;
            }
            
            // Memory modes - handle disc and stick input
            if (state.difficulty !== 'easy') {
                const memoryScreen = document.getElementById('memoryScreen');
                if (!memoryScreen.classList.contains('hidden')) {
                    
                    // Number keys for input
                    if (num >= 0 && num <= 9) {
                        if (state.currentInput.length === 0) {
                            // First input - disc number (1 to numDiscs)
                            if (num >= 1 && num <= state.numDiscs) {
                                handleInput(num.toString());
                            }
                        } else if (state.currentInput.length === 1) {
                            // Second input - stick number (1-3)
                            if (num >= 1 && num <= 3) {
                                handleInput(num.toString());
                            }
                        }
                    }
                    
                    // Escape key to cancel current input
                    if (key === 'Escape' && state.currentInput.length > 0) {
                        state.currentInput = '';
                        updateMoveTable();
                    }
                    
                    // R key to reset
                    if (key.toLowerCase() === 'r') {
                        resetMemory();
                    }
                    
                    // C key to check (if checks remaining)
                    if (key.toLowerCase() === 'c' && state.checksRemaining > 0) {
                        checkSolution();
                    }
                }
            }
        });
    </script>
</body>
</html>
